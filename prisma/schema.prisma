// Marketing Identity Platform - PostgreSQL Schema
// This schema matches the in-memory data structures in route.js

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// PLATFORM CATALOG (Master list of supported platforms)
// ============================================================================

model CatalogPlatform {
  id                    String   @id @default(uuid())
  name                  String   @unique
  slug                  String   @unique
  domain                String   // 'Paid Media', 'Analytics', 'CRM', 'Data Warehouse', etc.
  description           String?
  icon                  String?  // Font Awesome icon class or URL
  tier                  Int      @default(2) // 1 = Tier 1, 2 = Tier 2
  clientFacing          Boolean  @default(true)
  automationFeasibility String?  // 'High', 'Medium', 'Low'
  supportedItemTypes    String[] // ['NAMED_INVITE', 'PARTNER_DELEGATION', 'GROUP_ACCESS', etc.]
  accessPatterns        Json?    // Array of { pattern, roles, description }
  notes                 String?
  oauthSupported        Boolean  @default(false)
  oauthConfig           Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  agencyPlatforms    AgencyPlatform[]
  accessRequestItems AccessRequestItem[]

  @@index([domain])
  @@index([clientFacing])
  @@map("catalog_platforms")
}

// ============================================================================
// CLIENTS
// ============================================================================

model Client {
  id        String   @id @default(uuid())
  name      String
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessRequests AccessRequest[]

  @@map("clients")
}

// ============================================================================
// AGENCY PLATFORMS (Agency's configured platforms with access items)
// ============================================================================

model AgencyPlatform {
  id         String   @id @default(uuid())
  platformId String
  isEnabled  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  platform    CatalogPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  accessItems AccessItem[]

  @@unique([platformId])
  @@map("agency_platforms")
}

// Access items configured by the agency admin
model AccessItem {
  id               String   @id @default(uuid())
  agencyPlatformId String
  
  // Item configuration
  itemType         String   // NAMED_INVITE, PARTNER_DELEGATION, GROUP_ACCESS, SHARED_ACCOUNT_PAM, PROXY_TOKEN
  accessPattern    String?  // Derived from itemType
  patternLabel     String?
  label            String
  role             String
  notes            String?
  
  // Identity taxonomy (for NAMED_INVITE)
  identityPurpose        String?  // HUMAN_INTERACTIVE, INTEGRATION_NON_INTERACTIVE
  humanIdentityStrategy  String?  // AGENCY_GROUP, INDIVIDUAL_USERS
  agencyGroupEmail       String?
  
  // Integration identity reference (for PROXY_TOKEN, GROUP_ACCESS)
  integrationIdentityId  String?
  
  // Agency data (MCC ID, BM ID, etc. for Partner Delegation)
  agencyData             Json?
  
  // PAM configuration (for SHARED_ACCOUNT_PAM)
  pamConfig              Json?
  
  // Validation
  validationMethod       String?  @default("ATTESTATION")
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  agencyPlatform AgencyPlatform @relation(fields: [agencyPlatformId], references: [id], onDelete: Cascade)

  @@index([agencyPlatformId])
  @@index([itemType])
  @@map("access_items")
}

// ============================================================================
// ACCESS REQUESTS & ONBOARDING
// ============================================================================

model AccessRequest {
  id          String    @id @default(uuid())
  clientId    String
  token       String    @unique @default(uuid())
  notes       String?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  client Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items  AccessRequestItem[]

  @@index([clientId])
  @@index([token])
  @@map("access_requests")
}

// Individual items within an access request
model AccessRequestItem {
  id              String   @id @default(uuid())
  accessRequestId String
  platformId      String
  
  // Access configuration (copied from AccessItem at request time)
  itemType        String
  accessPattern   String?
  patternLabel    String?
  role            String
  assetName       String?
  
  // Identity fields
  identityPurpose       String?
  humanIdentityStrategy String?
  resolvedIdentity      String?  // Generated email/identity for this request
  agencyGroupEmail      String?
  
  // Agency data
  agencyData            Json?
  
  // PAM fields
  pamOwnership          String?  // CLIENT_OWNED, AGENCY_OWNED
  pamConfig             Json?
  pamUsername           String?
  pamSecretRef          String?  // Encrypted reference to credentials
  
  // Client-provided target (collected during onboarding)
  clientProvidedTarget  Json?
  
  // Client instructions
  clientInstructions    String?  @db.Text
  
  // Status tracking
  status                String   @default("pending") // pending, validated, needs_evidence, failed
  validatedAt           DateTime?
  validatedBy           String?
  validationMode        String?
  validationResult      Json?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  accessRequest AccessRequest   @relation(fields: [accessRequestId], references: [id], onDelete: Cascade)
  platform      CatalogPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@index([accessRequestId])
  @@index([platformId])
  @@index([status])
  @@map("access_request_items")
}

// ============================================================================
// INTEGRATION IDENTITIES (Service accounts, API keys, etc.)
// ============================================================================

model IntegrationIdentity {
  id          String   @id @default(uuid())
  name        String
  type        String   // SERVICE_ACCOUNT, API_KEY, OAUTH_CLIENT
  identifier  String   // Email, key ID, client ID
  description String?
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("integration_identities")
}

// ============================================================================
// PAM SESSIONS (Credential checkouts)
// ============================================================================

model PamSession {
  id              String    @id @default(uuid())
  requestId       String
  itemId          String
  platformId      String
  userId          String
  checkedOutAt    DateTime  @default(now())
  expiresAt       DateTime
  checkedInAt     DateTime?
  status          String    @default("active") // active, expired, checked_in
  credentialRef   String?   // Reference to decrypted credentials
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([requestId])
  @@index([status])
  @@map("pam_sessions")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  event      String   // ACCESS_GRANTED, CREDENTIAL_CHECKED_OUT, etc.
  actor      String   // User ID or 'system'
  requestId  String?
  itemId     String?
  platformId String?
  details    Json?
  timestamp  DateTime @default(now())

  @@index([event])
  @@index([requestId])
  @@index([timestamp])
  @@map("audit_logs")
}
