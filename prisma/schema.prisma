// Marketing Identity Platform - Enterprise Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AGENCY & BRANDING
// ============================================================================

model AgencySettings {
  id             String   @id @default(uuid())
  agencyName     String   @default("Marketing Agency")
  logoUrl        String?
  primaryColor   String   @default("#2563eb") // Blue
  secondaryColor String   @default("#7c3aed") // Purple
  subdomain      String?  @unique
  supportEmail   String   @default("support@agency.com")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("agency_settings")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      String   @default("user") // 'admin' | 'user'
  oktaId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessRequests    AccessRequest[]
  validationHistory ValidationHistory[]

  @@map("users")
}

// ============================================================================
// PLATFORMS & CATALOG
// ============================================================================

model Platform {
  id                     String   @id @default(uuid())
  name                   String   @unique
  slug                   String   @unique
  domain                 String // 'Paid Media', 'Analytics', 'CRM', etc.
  description            String?
  iconName               String?  // Font Awesome icon name or custom SVG identifier
  tier                   Int      @default(2) // 1 = Tier 1 (full asset support), 2 = Tier 2 (platform-level)
  clientFacing           Boolean  @default(true) // false for internal tools like Gong
  automationFeasibility  String // 'High', 'Medium', 'Low', 'Medium-High', 'Low-Medium'
  accessPatterns         Json // Array of access pattern objects: [{ pattern: '1 (Partner Hub)', roles: ['Admin', 'Standard'] }]
  notes                  String?
  oauthSupported         Boolean  @default(false)
  oauthConfig            Json? // OAuth configuration if supported
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  configuredApps       ConfiguredApp[]
  accessRequestItems   AccessRequestItem[]
  secrets              Secret[]

  @@index([domain])
  @@index([tier])
  @@index([clientFacing])
  @@map("platforms")
}

// ============================================================================
// CLIENTS & CONFIGURED APPS
// ============================================================================

model Client {
  id        String   @id @default(uuid())
  name      String
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  configuredApps   ConfiguredApp[]
  accessRequests   AccessRequest[]
  platformAccounts PlatformAccount[]
  secrets          Secret[]

  @@map("clients")
}

// Per-client platform configuration
model ConfiguredApp {
  id         String   @id @default(uuid())
  clientId   String
  platformId String
  isActive   Boolean  @default(true) // Can be toggled on/off
  config     Json? // Platform-specific configuration
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platform Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@unique([clientId, platformId])
  @@index([clientId])
  @@index([platformId])
  @@map("configured_apps")
}

// ============================================================================
// ACCESS REQUESTS & ONBOARDING
// ============================================================================

model AccessRequest {
  id          String    @id @default(uuid())
  clientId    String
  token       String    @unique @default(uuid())
  createdBy   String
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [createdBy], references: [id])

  items             AccessRequestItem[]
  validationHistory ValidationHistory[]

  @@index([clientId])
  @@index([token])
  @@map("access_requests")
}

// Individual access request items (per platform, access pattern, role, asset)
model AccessRequestItem {
  id              String    @id @default(uuid())
  accessRequestId String
  platformId      String
  
  // Access configuration
  accessPattern   String // e.g., '1 (Partner Hub)', '2 (Named Invites)'
  role            String // e.g., 'Admin', 'Standard', 'Read-only'
  
  // Asset-level selection (for Tier 1 platforms)
  assetType       String? // e.g., 'Ad Account', 'Business Manager', 'Page', 'Pixel'
  assetId         String? // Client-provided or auto-discovered asset ID
  assetName       String? // Human-readable asset name
  
  // Status tracking
  status          String    @default("pending") // 'pending', 'validated', 'failed'
  validatedAt     DateTime?
  validatedBy     String? // Connector name or 'manual'
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  accessRequest AccessRequest @relation(fields: [accessRequestId], references: [id], onDelete: Cascade)
  platform      Platform      @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@index([accessRequestId])
  @@index([platformId])
  @@index([status])
  @@map("access_request_items")
}

// ============================================================================
// PLATFORM ACCOUNTS & GRANTS
// ============================================================================

model PlatformAccount {
  id                String   @id @default(uuid())
  platformId        String
  clientId          String
  accountIdentifier String // e.g., Google Ads MCC ID, email, etc.
  accountName       String?
  status            String   @default("pending") // 'active', 'pending', 'revoked'
  metadata          Json? // Platform-specific account data
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  grants Grant[]

  @@index([clientId])
  @@map("platform_accounts")
}

model Grant {
  id                 String    @id @default(uuid())
  userId             String
  platformAccountId  String
  role               String // Platform-specific role
  grantedAt          DateTime  @default(now())
  revokedAt          DateTime?

  platformAccount PlatformAccount @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platformAccountId])
  @@map("grants")
}

// ============================================================================
// AUDIT & VALIDATION HISTORY
// ============================================================================

model ValidationHistory {
  id              String   @id @default(uuid())
  accessRequestId String?
  userId          String
  action          String // 'created', 'validated', 'failed', 'refreshed', 'revoked'
  targetType      String // 'access_request', 'platform', 'item'
  targetId        String
  metadata        Json? // Additional context
  timestamp       DateTime @default(now())

  accessRequest AccessRequest? @relation(fields: [accessRequestId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id])

  @@index([accessRequestId])
  @@index([userId])
  @@index([timestamp])
  @@map("validation_history")
}

// ============================================================================
// SECRETS & VAULT FOUNDATION
// ============================================================================

model Secret {
  id             String    @id @default(uuid())
  type           String // 'oauth_token', 'api_key', 'password', 'service_account'
  platformId     String
  clientId       String?
  encryptedValue String // Encrypted using KMS or envelope encryption
  metadata       Json? // Additional secret metadata (scopes, expiry, etc.)
  rotationPolicy Json? // { frequency: '90d', lastRotated: '2024-01-01', nextRotation: '2024-04-01' }
  lastRotated    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  platform Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([platformId])
  @@index([clientId])
  @@index([type])
  @@map("secrets")
}
