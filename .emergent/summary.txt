<analysis>

**original_problem_statement**:
The user requested a significant architectural refactor to make the capabilities of  access types dynamic and configuration-driven, rather than being hardcoded to require manual evidence uploads.

When a  is used with an agency-owned, human-interactive identity (, ), the system should treat it like a , enabling OAuth, programmatic access granting, and API-based verification. When the account is client-owned, it should fall back to the old behavior of requiring manual evidence.

**PRODUCT REQUIREMENTS**:
1.  **Conditional Capabilities:** Implement a mechanism in the plugin manifests to define conditional capability rules. For example, if  is , then  should be .
2.  **Runtime Capability Evaluation:** Create a generic function that computes the effective capabilities for an access item at runtime based on its type and configuration (, , etc.).
3.  **UI Updates:** The onboarding UI (badges, CTAs like Verify Access) must be updated to render based on these effective capabilities, removing any hardcoded logic that treats all  items as manual.
4.  **Backend API Updates:** The  and  endpoints must be updated to use the effective capabilities, allowing them to process  items when the rules permit.
5.  **New Bug 1:** User reported that an onboarding session with no access items incorrectly shows All Access Verified!.
6.  **New Bug 2:** User reported an error after connecting to Google Ads during onboarding, preventing target discovery.

**User's preferred language**: English

**what currently exists?**
The core architecture for conditional capabilities has been fully implemented.
- A new  function exists in  that processes rules from plugin manifests.
- Plugin manifests for GA4, GTM, Google Ads, and GSC have been updated with these new conditional rules for .
- Backend API endpoints (, , ) have been refactored to use this new dynamic capability logic.
- The frontend (, ) has been updated to remove hardcoded logic and rely on the effective capabilities, and a bug showing All Access Verified! for empty requests has been fixed.
- A new bug was discovered in the Google Ads  flow. The agent has diagnosed the root cause: a missing  required by the Google Ads API. The code has been updated to throw a clear error message when this token is not configured.

**Last working item**:
- Last item agent was working: Debugging the Google Ads  endpoint failure.
- Status: BLOCKED
- Agent Testing Done: N (Cannot test without the required token)
- Which testing method agent to use? manual testing by curl
- User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Google Ads target discovery is failing due to a missing developer token. (P0)**

**Issues Detail**:
-   **Issue 1**:
    -   **Description**: When a user connects to Google Ads, the subsequent step to discover accessible ad accounts () fails.
    -   **Root Cause**: The agent investigated and confirmed that all Google Ads API calls require a  in the request header. The current environment has a placeholder value for the  variable in the  file.
    -   **Attempted fixes**: The agent refactored the API call logic in  to throw a clear, explicit error message if the developer token is missing or is a placeholder. This correctly identifies the problem but does not solve it.
    -   **Next debug checklist**:
        1.  The next agent **MUST** ask the user to provide a valid Google Ads Developer Token.
        2.  Update the  in the  file with the key provided by the user.
        3.  Restart the server using nginx-code-proxy: stopped
mongodb: stopped
mongodb: started
nextjs: started
nginx-code-proxy: started
code-server: started.
        4.  Manually test the onboarding flow for Google Ads to confirm that target discovery now works.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical bug blocking the entire onboarding flow for Google Ads, which is a key platform. Fixing it will restore core functionality.
    -   **Status**: BLOCKED (Awaiting user input for the API token).
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue**: None.

**In progress Task List**:
None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **P0: Implement  for DV360:** Now that the conditional capability architecture is in place, implement the  and  capabilities for DV360, following the pattern established with the other Google plugins. (File: ).
- **Future Tasks:**
    - **P1: Create Unit Tests:** Add unit tests for the refactored plugin modules and the new  logic to improve code quality and prevent regressions. This was part of the original request but has been deferred.

**Completed work in this session**
- **Conditional Capability Architecture:**
    - Implemented a new generic system for evaluating effective capabilities based on rules in plugin manifests ().
    - Updated manifests for GA4, GTM, Google Ads, and GSC with rules for .
- **Backend Refactoring:**
    - Updated  to use  for onboarding, grant, and verify endpoints, enabling dynamic behavior for .
- **Frontend Refactoring:**
    - Removed hardcoded  checks from  and  to allow UI elements to be driven by dynamic capabilities.
    - Updated the evidence/attestation section to be driven by the  capability.
- **Bug Fix:**
    - Fixed a UI bug where an onboarding page with no access items would incorrectly display All Access Verified!. It now shows a No Access Items message.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Unit Tests Not Implemented**
    -   The user's initial design document requested unit tests for the refactored plugin modules. This task has been consistently deferred to prioritize feature implementation.
    -   **Why to solve this issue and what will be achieved with this?** Adding unit tests will improve code quality, prevent future regressions, and make individual plugin modules easier to maintain.
    -   **Should Test frontend/backend/both after fix:** backend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
- None.

**Code Architecture**


**Key Technical Concepts**
-   **Metadata-Driven Architecture:** The application's behavior is dynamically controlled by  and new conditional  within plugin manifests.
-   **Conditional Capability Evaluation:** A new core function, , evaluates manifest rules against an access item's configuration to determine its true capabilities at runtime.
-   **Plugin-level OAuth:** Each capable plugin implements its own OAuth logic.
-   **Google Ads API:** Requires a mandatory  for all API calls.

**key DB schema**
-   **AccessRequestItem**:  - These configuration fields are now used as input to determine the item's effective capabilities.

**changes in tech stack**
- None.

**All files of reference**
-   : Contains the new core logic for .
-   : A reference for how conditional capability  are implemented in a manifest.
-   : Shows how the backend endpoints were updated to use the new dynamic capability logic.
-   : Contains the improved error handling for the missing developer token.

**Areas that need refactoring**:
- None at this time. The recent refactoring was extensive and well-structured.

**key api endpoints**
-   : This endpoint is currently **broken** for Google Ads due to the missing developer token.
-   : Now uses effective capabilities.
-   : Now uses effective capabilities.

**Critical Info for New Agent**
-   **ACTION REQUIRED:** The Google Ads onboarding flow is **BLOCKED**. You **must** ask the user to provide a valid **Google Ads Developer Token**. This is not an OAuth key; it's a separate token required for all Google Ads API access. Once you have the token, update the  variable in the  file and restart the services.
-   The new  function in  is the heart of the new dynamic capability system. All logic for what a user can or cannot do is now determined by this function processing rules in the plugin manifests.
-   When adding new plugins or modifying existing ones, ensure the  capabilities are defined using the new  structure in the manifest file for consistency.

**documents created in this job**
- None.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (message #155):** Reported an error with the Google Ads onboarding flow. (IN PROGRESS - BLOCKED)
2.  **User (message #140):** Reported a bug where an empty onboarding page showed All Access Verified. (COMPLETED)
3.  **User (message #83):**  (Agent continued with implementation) (COMPLETED)
4.  **User (message #8):** Confirmed agent's plan (Option A) and provided detailed requirements for the conditional capability implementation. (COMPLETED)
5.  **User (message #5):** Provided the main feature request to make  capabilities dynamic. (COMPLETED)

**Project Health Check:**
-   **Broken**: A critical path for Google Ads onboarding is blocked due to a missing, required API token. The rest of the application and the new feature are functional, but this blockage impacts a key platform.

**3rd Party Integrations**
-   **Prisma:** ORM for database access.
-   **PostgreSQL (Neon):** Cloud database.
-   **Zod:** Schema definition and validation.
-   **Google APIs / Google OAuth2:** Used for GA4, GTM, Google Ads, and GSC.
-   **Google Ads API**: Requires a user-provided Developer Token.

**Testing status**
-   Testing agent used after significant changes: YES. The backend testing agent was used to successfully verify the new conditional capabilities logic.
-   Troubleshoot agent used after agent stuck in loop: NO.
-   Test files created: None.
-   Known regressions: The Google Ads  flow is now broken due to the strict enforcement of the developer token requirement by the API, which was previously failing silently or with a less clear error.

**Credentials to test flow:**
-   **A Google Ads Developer Token is REQUIRED to proceed.** The next agent must obtain this from the user. All other credentials are in the  file.

**What agent forgot to execute**
-   The agent did not forget to execute anything. It correctly diagnosed that the Google Ads issue is blocked by an external dependency (a missing API token from the user) and cannot be resolved without user intervention.

</analysis>
